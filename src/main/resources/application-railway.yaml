# ============================================================================
# Railway 환경용 Spring Boot 설정
# Gateway, OAuth Service, User Service 통합 설정
# ============================================================================

spring:
  application:
    name: gateway
  
  # Railway PostgreSQL 데이터베이스 설정
  datasource:
    url: ${DATABASE_URL}
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  
  # JPA/Hibernate 설정
  jpa:
    hibernate:
      ddl-auto: update
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          time_zone: Asia/Seoul
  
  # Upstash Redis 설정 (TLS 필수)
  # OAuth Service와 공통 사용
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}
      ssl:
        enabled: ${REDIS_SSL_ENABLED:true}
      timeout: 2000ms
      database: 0
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
        ssl:
          enabled: true
          verify-peer: true

  # Cloud Gateway 설정
  cloud:
    gateway:
      routes:
        # Core Services
        - id: oauth-service
          uri: http://oauthservice:8081
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
            
        - id: user-service
          uri: http://userservice:8082
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
            
        # ERP Services
        - id: customer-service
          uri: http://customerservice:9009
          predicates:
            - Path=/api/erp/customer/**
          filters:
            - StripPrefix=2
            
        - id: dashboard-service
          uri: http://dashboardservice:9008
          predicates:
            - Path=/api/erp/dashboard/**
          filters:
            - StripPrefix=2
            
        - id: order-service
          uri: http://orderservice:9007
          predicates:
            - Path=/api/erp/order/**
          filters:
            - StripPrefix=2
            
        - id: report-service
          uri: http://reportservice:9006
          predicates:
            - Path=/api/erp/report/**
          filters:
            - StripPrefix=2
            
        - id: setting-service
          uri: http://settingservice:9005
          predicates:
            - Path=/api/erp/setting/**
          filters:
            - StripPrefix=2
            
        - id: stock-service
          uri: http://stockservice:9004
          predicates:
            - Path=/api/erp/stock/**
          filters:
            - StripPrefix=2
            
        # AI Services
        - id: ai-auth-service
          uri: http://ai-authservice:9002
          predicates:
            - Path=/api/ai/auth/**
          filters:
            - StripPrefix=2
            
        - id: crawler-service
          uri: http://crawlerservice:9001
          predicates:
            - Path=/api/ai/crawler/**
          filters:
            - StripPrefix=2
            
        - id: chatbot-service
          uri: http://chatbotservice:9003
          predicates:
            - Path=/api/ai/chatbot/**
          filters:
            - StripPrefix=2
            
        # ML Services
        - id: mlservice
          uri: http://mlservice:9010
          predicates:
            - Path=/api/mlservice/**
          filters:
            - StripPrefix=2

server:
  port: 8080

# ============================================================================
# SpringDoc OpenAPI (Swagger) 설정
# ============================================================================
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    path: /docs
    enabled: true
    operations-sorter: method
    tags-sorter: alpha
    use-root-path: false
    persist-authorization: true
    urls:
      - name: Gateway APIs
        url: /v3/api-docs
      - name: Transformer Service
        url: /koelectra/openapi.json
      - name: ML Service
        url: /api/mlservice/openapi.json
  show-actuator: false
  default-flat-param-object: true
  writer-with-order-by-keys: true

# ============================================================================
# OAuth Service 설정 (core.minsol.kr/oauthservice 통합)
# ============================================================================
oauth:
  kakao:
    rest-api-key: ${KAKAO_REST_API_KEY}
    redirect-uri: ${KAKAO_REDIRECT_URI}
  google:
    client-id: ${GOOGLE_CLIENT_ID}
    client-secret: ${GOOGLE_CLIENT_SECRET}
    redirect-uri: ${GOOGLE_REDIRECT_URI}
  naver:
    client-id: ${NAVER_CLIENT_ID}
    client-secret: ${NAVER_CLIENT_SECRET}
    redirect-uri: ${NAVER_REDIRECT_URI}

# JWT 설정 (OAuth Service와 공통 사용)
jwt:
  secret: ${JWT_SECRET}
  access-token-expiration: ${JWT_ACCESS_TOKEN_EXPIRATION:3600000}
  refresh-token-expiration: ${JWT_REFRESH_TOKEN_EXPIRATION:2592000000}

# ============================================================================
# User Service 설정 (core.minsol.kr/adminservice 통합)
# ============================================================================
# User Service는 별도 포트(8082)에서 실행되며, Gateway를 통해 라우팅됩니다.
# Railway 환경에서는 별도 서비스로 배포됩니다.

# 로깅 설정
logging:
  level:
    kr.minsol: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web: DEBUG
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# 관리 엔드포인트
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
